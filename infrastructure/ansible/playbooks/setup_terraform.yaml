- name: Install Terraform
  become: true
  hosts: local
  gather_facts: true
  tasks:
  - name: Install packages needed for verifying Hashicorp's GPG keys
    ansible.builtin.apt:
      state: present
      update_cache: false
      name: gnupg

  - name: Add Hashicorp's GPG key
    ansible.builtin.get_url:
      url: https://apt.releases.hashicorp.com/gpg
      dest: /usr/share/keyrings/hashicorp-archive-keyring.gpg
  
  - name: Add Hashicorp's repository
    ansible.builtin.apt_repository:
      repo: "deb [arch={{ 'amd64' if ansible_architecture == 'x86_64' else ansible_architecture }} signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
      state: present
      filename: hashicorp
  
  - name: Install Terraform
    ansible.builtin.apt:
      state: latest
      update_cache: true
      name: terraform

- name: Bootstrap Terraform's remote backend and providers' authentication
  hosts: local

  vars_prompt:
    - name: aws_access_key_id
      prompt: AWS Access Key ID
      private: false

    - name: aws_secret_access_key
      prompt: AWS Access Key secret
      private: true
      unsafe: true

    - name: digitalocean_token
      prompt: DigitalOcean API Token
      private: true
      unsafe: true

  tasks: 
    - name: Create the AWS S3 bucket that will store Terraform's state file
      environment: 
        AWS_ACCESS_KEY_ID: "{{ aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key }}"
      community.general.terraform:
        project_path: "{{ playbook_dir }}/../../terraform/backend"
        force_init: true
        state: present

    - name: Create Terraform's .env file
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/dot_env.j2"
        dest: "{{ playbook_dir }}/../../terraform/.env"
        mode: "0600"
        